<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coachingtest – Livskvalitet</title>
  <style>
    :root{--bg:#f7f7f8;--card:#ffffff;--ink:#111;--muted:#6b7280;--line:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:24px}
    h1{font-size:clamp(20px,3vw,28px);margin:0 0 12px;font-weight:800}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--ink);background:var(--ink);color:#fff;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.sec{background:#fff;color:var(--ink)}
    .pill{border:1px solid var(--line);border-radius:12px;padding:10px 14px;cursor:pointer;user-select:none}
    .pill.sel{outline:2px solid var(--ink)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .prog{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .prog>div{height:100%;background:#111;width:0}
    .qarea{font-size:14px;color:var(--muted);margin-bottom:6px}
    .qtext{font-size:18px;font-weight:600;margin-bottom:12px}
    .actions{display:flex;justify-content:space-between;align-items:center;margin-top:16px}
    .stack{display:grid;gap:12px}
    .bar{height:16px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar>div{height:100%;background:#111}
    .list{margin:0;padding-left:18px}
    .list li{margin:6px 0}
    .grid{display:grid;gap:16px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .footnote{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .scoreBox{font-size:48px;font-weight:900;text-align:center;padding:20px;border-radius:16px}
    .qrWrap{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .qrImg{width:180px;height:180px;border:1px solid var(--line);border-radius:12px;object-fit:contain;background:#fff}
    .copy{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f9fafb;border:1px solid var(--line);border-radius:10px;padding:6px 10px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.18);max-width:520px;width:100%;padding:20px}
    .modal h2{margin:0 0 8px;font-size:20px}
    .modal .muted{margin-bottom:12px}
    .modal .actions{justify-content:flex-end;gap:8px}

    /* Kodfält */
    .codeRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .codeInput{padding:10px 12px;border:1px solid var(--line);border-radius:10px;min-width:200px}
    .codeMsg{font-size:12px}
    .ok{color:#16a34a}
    .err{color:#b91c1c}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app"></div>
  </div>

  <!-- Modal för Swish-bekräftelse -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle">Bekräfta betalning</h2>
      <div class="muted" id="modalText"></div>
      <div class="actions">
        <button class="btn sec" id="modalCancel">Avbryt</button>
        <button class="btn" id="modalOk">Öppna Swish nu</button>
      </div>
    </div>
  </div>

  <script>
    // ------------------ DATA ------------------
    const QUESTIONS = [
      { id:1, area:"Ekonomi", text:"Jag har en tydlig överblick över mina inkomster och utgifter.", type:"scale" },
      { id:2, area:"Ekonomi", text:"Jag har en buffert/sparande som gör att jag känner mig trygg.", type:"scale" },
      { id:3, area:"Ekonomi", text:"Jag oroar mig ofta för pengar.", type:"yn", reverse:true },
      { id:4, area:"Ekonomi", text:"Jag upplever att min ekonomiska situation är stabil.", type:"scale" },
      { id:5, area:"Ekonomi", text:"Jag kan betala mina räkningar i tid varje månad.", type:"yn" },
      { id:6, area:"Ekonomi", text:"Jag har kontroll över eventuella skulder.", type:"scale" },
      { id:7, area:"Ekonomi", text:"Jag har råd med sådant som ger mig livskvalitet (t.ex. resor, fritid).", type:"scale" },
      { id:8, area:"Ekonomi", text:"Jag har en långsiktig plan för min ekonomi.", type:"yn" },
      { id:9, area:"Ekonomi", text:"Min ekonomi skapar stress i mitt liv.", type:"yn", reverse:true },
      { id:10, area:"Ekonomi", text:"Jag känner mig nöjd med min ekonomiska situation just nu.", type:"scale" },

      { id:11, area:"Fysisk hälsa", text:"Jag äter en balanserad och näringsrik kost.", type:"scale" },
      { id:12, area:"Fysisk hälsa", text:"Jag tränar regelbundet (minst 2 gånger i veckan).", type:"yn" },
      { id:13, area:"Fysisk hälsa", text:"Jag känner mig pigg och energifylld under dagarna.", type:"scale" },
      { id:14, area:"Fysisk hälsa", text:"Jag får tillräckligt med sömn av god kvalitet.", type:"scale" },
      { id:15, area:"Fysisk hälsa", text:"Jag röker, snusar eller använder andra beroendeframkallande substanser.", type:"yn", reverse:true },
      { id:16, area:"Fysisk hälsa", text:"Jag upplever att min kropp fungerar bra i vardagen.", type:"scale" },
      { id:17, area:"Fysisk hälsa", text:"Jag hanterar stress på ett hälsosamt sätt.", type:"scale" },
      { id:18, area:"Fysisk hälsa", text:"Jag går på hälsokontroller eller följer upp min hälsa vid behov.", type:"yn" },
      { id:19, area:"Fysisk hälsa", text:"Jag är ofta sjuk eller upplever återkommande smärta.", type:"yn", reverse:true },
      { id:20, area:"Fysisk hälsa", text:"Jag är nöjd med min fysiska hälsa i nuläget.", type:"scale" },

      { id:21, area:"Relationer", text:"Jag har personer i mitt liv som jag kan lita på.", type:"scale" },
      { id:22, area:"Relationer", text:"Jag upplever att mina relationer ger mig energi snarare än tar energi.", type:"scale" },
      { id:23, area:"Relationer", text:"Jag har en nära vän som jag kan prata öppet med.", type:"yn" },
      { id:24, area:"Relationer", text:"Jag känner mig uppskattad av människor runt mig.", type:"scale" },
      { id:25, area:"Relationer", text:"Jag har konflikter som påverkar mig negativt i vardagen.", type:"yn", reverse:true },
      { id:26, area:"Relationer", text:"Jag upplever att min familj eller partner stöttar mig.", type:"scale" },
      { id:27, area:"Relationer", text:"Jag är nöjd med mitt sociala liv (antal vänner, umgänge, gemenskap).", type:"scale" },
      { id:28, area:"Relationer", text:"Jag känner mig ofta ensam.", type:"yn", reverse:true },
      { id:29, area:"Relationer", text:"Jag upplever att jag bidrar positivt till andras liv.", type:"scale" },
      { id:30, area:"Relationer", text:"Jag är nöjd med kvaliteten på mina relationer.", type:"scale" },

      { id:31, area:"Sysselsättning", text:"Jag är nöjd med mitt arbete eller min huvudsakliga sysselsättning.", type:"scale" },
      { id:32, area:"Sysselsättning", text:"Jag känner att jag utvecklas i mitt arbete/studier.", type:"scale" },
      { id:33, area:"Sysselsättning", text:"Jag känner mig ofta stressad av mitt arbete eller mina studier.", type:"yn", reverse:true },
      { id:34, area:"Sysselsättning", text:"Jag tycker att min sysselsättning känns meningsfull.", type:"scale" },
      { id:35, area:"Sysselsättning", text:"Jag upplever balans mellan arbete/studier och fritid.", type:"scale" },
      { id:36, area:"Sysselsättning", text:"Jag har en tydlig plan för min karriär eller framtida mål.", type:"yn" },
      { id:37, area:"Sysselsättning", text:"Jag känner att mina styrkor och förmågor kommer till nytta i det jag gör.", type:"scale" },
      { id:38, area:"Sysselsättning", text:"Jag har en arbetsmiljö som är hälsosam och trivsam.", type:"scale" },
      { id:39, area:"Sysselsättning", text:"Jag känner mig uppskattad av kollegor/medstudenter/arbetsgivare.", type:"scale" },
      { id:40, area:"Sysselsättning", text:"Jag skulle vilja förändra min nuvarande sysselsättning.", type:"yn", reverse:true },
    ];
    const AREAS = ["Ekonomi","Fysisk hälsa","Relationer","Sysselsättning"];

    // --- KONFIGURATION ---
    const CONFIG = {
      priceSEK: 50, // skickas som 50.00 i deeplink/QR
      swishPayee: "0763044124",
      apiBase: "https://qol-linker.kalleandersson872.workers.dev",
      links: {
        "Sysselsättning": "https://kalleandersson872-design.github.io/sysselsattning/",
        "Ekonomi":        "https://kalleandersson872-design.github.io/ekonomi1/",
        "Relationer":     "https://kalleandersson872-design.github.io/relationer/",
        "Fysisk hälsa":   "https://kalleandersson872-design.github.io/fysisk-halsa-test/",
      },
      freeCode: "neabus" // gratis-kod
    };

    // ------------------ STATE ------------------
    let idx = 0;
    const answers = {};
    const app = document.getElementById('app');

    // ------------------ HELPERS ------------------
    function isMobile(){
      return /iphone|ipad|ipod|android|windows phone/i.test(navigator.userAgent);
    }
    function mapAnswerToScore(q, value){
      if(q.type === 'scale'){
        const v = Number(value);
        return v >= 1 && v <= 5 ? v : 0;
      }
      if(q.type === 'yn'){
        const yes = q.reverse ? 1 : 5;
        const no  = q.reverse ? 5 : 1;
        return value === 'Ja' ? yes : value === 'Nej' ? no : 0;
      }
      return 0;
    }
    function summary(){
      const sums = Object.fromEntries(AREAS.map(a=>[a,0]));
      QUESTIONS.forEach(q=>{ sums[q.area] += mapAnswerToScore(q, answers[q.id]); });
      const scores = Object.fromEntries(AREAS.map(a=>[a, Math.round((sums[a]/50)*100)]));
      return {sums, scores};
    }
    function progress(){ return Math.round(((idx+1)/QUESTIONS.length)*100); }

    function colorForPoints(p){
      if(p < 400) return "#ef4444";      // röd
      if(p >= 700) return "#16a34a";     // grön
      return "#f59e0b";                  // gul
    }

    function makeRef(area){
      const rnd = Math.random().toString(36).slice(2,8).toUpperCase();
      return `FOR${CONFIG.priceSEK}-${area.replace(/[^A-Za-zÅÄÖåäö]/g,'')}-${Date.now()}-${rnd}`;
    }

    function formatAmount(amount){
      const n = Number(amount);
      return n.toFixed(2); // 50.00
    }
    function formatAmountText(amount){
      return formatAmount(amount).replace('.', ',');
    }

    function swishDeepLink(payee, amount, message){
      const p = new URLSearchParams({
        version: "1",
        payee: String(payee),
        amount: formatAmount(amount),
        message: String(message)
      });
      return `swish://paymentrequest?${p.toString()}`;
    }
    function swishQrImageUrl(payee, amount, message){
      const deeplink = swishDeepLink(payee, amount, message);
      const encoded = encodeURIComponent(deeplink);
      return `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encoded}`;
    }

    async function createAndRedirect(area, ref, paidBtn, errEl){
      try{
        if (paidBtn){
          paidBtn.disabled = true;
          paidBtn.textContent = "Kontrollerar…";
        }
        if (errEl) errEl.style.display = 'none';

        const res = await fetch(`${CONFIG.apiBase}/create-link`,{
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ area, ref })
        });
        if(!res.ok) throw new Error('Serverfel: ' + res.status);
        const data = await res.json(); // { url, validForMinutes }
        window.location.replace(data.url); // direkt vidare
      }catch(e){
        if (errEl){
          errEl.textContent = "Kunde inte skapa länk. Kontrollera att apiBase är korrekt och att Workern är deployad. Detalj: " + (e?.message || e);
          errEl.style.display = 'block';
        } else {
          alert("Kunde inte skapa länk: " + (e?.message || e));
        }
        if (paidBtn){
          paidBtn.disabled = false;
          paidBtn.textContent = "Jag har betalat";
        }
      }
    }

    // Modal helpers
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalText = document.getElementById('modalText');
    const modalOk = document.getElementById('modalOk');
    const modalCancel = document.getElementById('modalCancel');
    function openModal(html, onOk){
      modalText.innerHTML = html;
      modalBackdrop.style.display = 'flex';
      function cleanup(){
        modalBackdrop.style.display = 'none';
        modalOk.onclick = null;
        modalCancel.onclick = null;
      }
      modalOk.onclick = ()=>{ cleanup(); onOk?.(); };
      modalCancel.onclick = cleanup;
      modalBackdrop.onclick = (e)=>{ if(e.target === modalBackdrop) cleanup(); };
    }

    // ------------------ RENDER ------------------
    function render(){
      if(idx >= QUESTIONS.length){
        const {scores} = summary();

        // totalpoäng 0–1000 (medel% * 10)
        const overallPct = Math.round((scores['Ekonomi'] + scores['Fysisk hälsa'] + scores['Relationer'] + scores['Sysselsättning']) / 4);
        const overallPoints = overallPct * 10;
        const scoreColor = colorForPoints(overallPoints);

        // område med lägst poäng (för upsell)
        const sorted = Object.entries(scores).sort((a,b)=>a[1]-b[1]);
        const lowest = sorted[0];
        const lowestArea = lowest ? lowest[0] : AREAS[0];
        const lowestVal  = lowest ? lowest[1] : 0;
        const ref = makeRef(lowestArea);

        app.innerHTML = `
          <h1>Ditt resultat</h1>

          <div class="stack" style="align-items:center;justify-content:center">
            <div class="scoreBox" style="color:${scoreColor}">
              ${overallPoints} poäng
            </div>
            <div class="muted">0 (sämst) – 1000 (bäst)</div>
          </div>

          <div class="hr"></div>

          <div class="grid">
            ${AREAS.map(a=>`
              <div class="stack">
                <div style="display:flex;justify-content:space-between;align-items:center"><strong>${a}</strong><span>${scores[a]}%</span></div>
                <div class="bar"><div style="width:${scores[a]}%"></div></div>
              </div>
            `).join('')}
          </div>

          <div class="hr"></div>

          <div class="stack" id="upsell">
            <strong>Fördjupande test</strong>
            <div class="muted">Lägst resultat: <strong>${lowestArea}</strong> (${lowestVal}%). Fördjupande test för <strong>${formatAmountText(CONFIG.priceSEK)} kr</strong> via Swish till <strong>${CONFIG.swishPayee}</strong> – eller ange en kod för gratis tillgång.</div>

            <!-- GRATIS-KOD -->
            <div class="stack" style="margin-top:6px">
              <div class="codeRow">
                <input id="freeCodeInput" class="codeInput" type="text" placeholder="Ange kod (t.ex. neabus)" />
                <button id="freeCodeBtn" class="btn sec">Lös in kod</button>
                <span id="freeCodeMsg" class="codeMsg muted"></span>
              </div>
            </div>

            <!-- Betalning -->
            <div id="payBox" class="stack" style="margin-top:8px"></div>

            <div class="row">
              <button id="paidBtn" class="btn sec">Jag har betalat</button>
            </div>

            <div class="footnote">Efter betalning eller godkänd kod skickas du automatiskt vidare till det fördjupande testet.</div>
            <div class="footnote" id="errorBox" style="display:none;color:#b91c1c">Ett fel uppstod. Kontrollera internet/inställningar och försök igen.</div>
          </div>

          <div class="row" style="margin-top:20px">
            <button class="btn" onclick="location.reload()">Gör om testet</button>
            <button class="btn sec" onclick="window.print()">Skriv ut / PDF</button>
          </div>
        `;

        // Element
        const payBox = document.getElementById('payBox');
        const paidBtn = document.getElementById('paidBtn');
        const errEl = document.getElementById('errorBox');
        const codeInput = document.getElementById('freeCodeInput');
        const codeBtn = document.getElementById('freeCodeBtn');
        const codeMsg = document.getElementById('freeCodeMsg');

        const amountFixed = formatAmount(CONFIG.priceSEK);
        const amountText = formatAmountText(CONFIG.priceSEK);
        const deeplink = swishDeepLink(CONFIG.swishPayee, amountFixed, ref);

        // Gratis-kod inlösen
        codeBtn.addEventListener('click', ()=>{
          const val = (codeInput.value || "").trim().toLowerCase();
          if(val === (CONFIG.freeCode || "").toLowerCase()){
            codeMsg.textContent = "Kod godkänd – du kommer att skickas vidare.";
            codeMsg.className = "codeMsg ok";
            // Skapa länk med "FREE" i ref för att kunna särskilja i loggar om du vill
            createAndRedirect(lowestArea, ref + "-FREE", null, errEl);
          } else {
            codeMsg.textContent = "Ogiltig kod.";
            codeMsg.className = "codeMsg err";
          }
        });

        // Bygg betalningsruta beroende på enhet
        if (isMobile()) {
          // MOBIL – "Öppna Swish" med bekräftelse-modal
          payBox.innerHTML = `
            <div class="row">
              <div class="muted">Mottagare: <span class="copy">${CONFIG.swishPayee}</span></div>
              <div class="muted">Belopp: <span class="copy">${amountText} kr</span></div>
              <div class="muted">Ref: <span class="copy" id="refText">${ref}</span> <button class="btn sec" id="copyRefBtn">Kopiera</button></div>
            </div>
            <div class="row">
              <a id="swishBtn" class="btn" href="#">Öppna Swish</a>
            </div>
            <div class="footnote">Om appen inte öppnas automatiskt, öppna Swish manuellt och ange uppgifterna exakt som ovan.</div>
          `;
          document.getElementById('copyRefBtn').onclick = ()=>{
            navigator.clipboard?.writeText(ref);
          };
          document.getElementById('swishBtn').onclick = (e)=>{
            e.preventDefault();
            openModal(
              `Du kommer att öppna Swish med följande uppgifter:<br><br>
               <strong>Belopp:</strong> ${amountText} kr<br>
               <strong>Mottagare:</strong> ${CONFIG.swishPayee}<br>
               <strong>Referens:</strong> ${ref}<br><br>
               Bekräfta för att fortsätta.`,
              ()=>{ try{ window.location.href = deeplink; }catch{} }
            );
          };
        } else {
          // DATOR – QR som kodar deeplinken (innehåller payee + amount)
          const qrUrl = swishQrImageUrl(CONFIG.swishPayee, amountFixed, ref);
          payBox.innerHTML = `
            <div class="qrWrap">
              <img class="qrImg" src="${qrUrl}" alt="Swish QR-kod" />
              <div class="stack">
                <div class="muted">Skanna QR med mobilen. Betalningen öppnas i Swish med rätt mottagare och belopp.</div>
                <div class="row"><div class="muted">Mottagare:</div> <div class="copy">${CONFIG.swishPayee}</div></div>
                <div class="row"><div class="muted">Belopp:</div>    <div class="copy">${amountText} kr</div></div>
                <div class="row"><div class="muted">Ref:</div>       <div class="copy" id="refText">${ref}</div> <button class="btn sec" id="copyRefBtn">Kopiera</button></div>
              </div>
            </div>
          `;
          document.getElementById('copyRefBtn').onclick = ()=>{
            navigator.clipboard?.writeText(ref);
          };
        }

        // "Jag har betalat" -> skapa länk & omdirigera direkt
        paidBtn.addEventListener('click', ()=>{
          createAndRedirect(lowestArea, ref, paidBtn, errEl);
        });

        return;
      }

      // --- FRÅGEVY ---
      const q = QUESTIONS[idx];
      const val = answers[q.id];
      const pct = progress();

      app.innerHTML = `
        <div class="topbar">
          <h1>Coachingtest – Livskvalitet</h1>
          <div class="muted">Fråga ${idx+1} av ${QUESTIONS.length} · ${pct}%</div>
        </div>
        <div class="prog" aria-hidden="true"><div style="width:${pct}%"></div></div>

        <div class="stack" style="margin-top:16px">
          <div class="qarea">${q.area}</div>
          <div class="qtext">${q.text}</div>
          <div class="row" id="opts"></div>
        </div>

        <div class="actions">
          <button class="btn sec" ${idx===0?'disabled':''} id="backBtn">Tillbaka</button>
          <button class="btn" ${val?"":"disabled"} id="nextBtn">${idx<QUESTIONS.length-1?"Nästa":"Visa resultat"}</button>
        </div>
        <div class="footnote">Alla frågor måste besvaras för att gå vidare.</div>
      `;

      const opts = document.getElementById('opts');
      if(q.type==='yn'){
        ['Ja','Nej'].forEach(opt=>{
          const el=document.createElement('div');
          el.className = 'pill' + (val===opt?' sel':'');
          el.textContent = opt;
          el.onclick = ()=>{ answers[q.id]=opt; render(); };
          opts.appendChild(el);
        });
      } else {
        [1,2,3,4,5].forEach(n=>{
          const el=document.createElement('div');
          el.className = 'pill' + (val===n?' sel':'');
          el.textContent = n;
          el.onclick = ()=>{ answers[q.id]=n; render(); };
          opts.appendChild(el);
        });
      }

      document.getElementById('backBtn').onclick = ()=>{ if(idx>0){ idx--; render(); }};
      document.getElementById('nextBtn').onclick = ()=>{ if(answers[q.id]!==undefined){ idx++; render(); }};
    }

    // Init
    render();
  </script>
</body>
</html>
